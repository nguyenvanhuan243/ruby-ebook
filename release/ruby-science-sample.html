<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
  </style>
</head>
<body>
<nav id="TOC">
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#contact-us">Contact Us</a></li>
<li><a href="#long-method">Long Method</a><ul>
<li><a href="#symptoms">Symptoms</a></li>
<li><a href="#example">Example</a></li>
<li><a href="#solutions">Solutions</a></li>
</ul></li>
<li><a href="#case-statement">Case Statement</a><ul>
<li><a href="#symptoms-1">Symptoms</a></li>
<li><a href="#type-codes">Type Codes</a><ul>
<li><a href="#example-1">Example</a></li>
<li><a href="#solutions-1">Solutions</a></li>
</ul></li>
</ul></li>
<li><a href="#shotgun-surgery">Shotgun Surgery</a><ul>
<li><a href="#symptoms-2">Symptoms</a></li>
<li><a href="#example-2">Example</a></li>
<li><a href="#solutions-2">Solutions</a></li>
<li><a href="#prevention">Prevention</a></li>
</ul></li>
<li><a href="#replace-conditional-with-null-object">Replace Conditional with Null Object</a><ul>
<li><a href="#uses">Uses</a></li>
<li><a href="#example-3">Example</a></li>
<li><a href="#drawbacks">Drawbacks</a></li>
<li><a href="#next-steps">Next Steps</a></li>
<li><a href="#truthiness-try-and-other-tricks">Truthiness, <code>try</code> and Other Tricks</a></li>
</ul></li>
<li><a href="#extract-method">Extract Method</a><ul>
<li><a href="#uses-1">Uses</a></li>
<li><a href="#example-4">Example</a></li>
<li><a href="#replace-temp-with-query">Replace Temp with Query</a><ul>
<li><a href="#other-examples">Other Examples</a></li>
<li><a href="#next-steps-1">Next Steps</a></li>
</ul></li>
</ul></li>
<li><a href="#extract-partial">Extract Partial</a><ul>
<li><a href="#uses-2">Uses</a></li>
<li><a href="#steps">Steps</a></li>
<li><a href="#example-5">Example</a></li>
<li><a href="#next-steps-2">Next Steps</a></li>
</ul></li>
<li><a href="#closing">Closing</a></li>
</ul>
</nav>
<section id="introduction" class="level1">
<h1><a href="#introduction">Introduction</a></h1>
<p>Ruby on Rails is almost a decade old, and its community has developed a number of principles for building applications that are fast, fun and easy to change: Don't repeat yourself, keep your views dumb, keep your controllers skinny, and keep business logic in your models. These principles carry most applications to their first release or beyond.</p>
<p>However, these principles only get you so far. After a few releases, most applications begin to suffer. Models become fat, classes become few and large, tests become slow and changes become painful. In many applications, there comes a day when the developers realize that there's no going back; the application is a twisted mess and the only way out is a rewrite or a new job.</p>
<p>Fortunately, it doesn't have to be this way. Developers have been using object-oriented programming for several decades and there's a wealth of knowledge out there that still applies to developing applications today. We can use the lessons learned by these developers to write good Rails applications by applying good object-oriented programming.</p>
<p>Ruby Science will outline a process for detecting emerging problems in code and will dive into the solutions, old and new.</p>
<p>The full book contains three catalogs: smells, solutions and principles. This sample contains a few hand-picked chapters from the first two catalogs, published directly from the book, allowing you to get a sense of the content, style and delivery of the product.</p>
<p>If you enjoy the sample, you can get access to the entire book and sample application at:</p>
<p><a href="http://www.rubyscience.com">http://www.rubyscience.com</a></p>
<p>As a purchaser of the book, you also get access to:</p>
<ul>
<li>Multiple formats, including HTML, PDF, EPUB and Kindle.</li>
<li>A complete example application containing code samples referenced in the book.</li>
<li>Access to a GitHub repository to receive updates as soon as they're pushed.</li>
<li>Access to GitHub Issues, where you can provide feedback and tell us what you'd like to see.</li>
<li>And you can ask us your toughest Rails questions!</li>
</ul>
</section>
<section id="contact-us" class="level1">
<h1><a href="#contact-us">Contact Us</a></h1>
<p>If you have any questions, or just want to get in touch, drop us a line at <script type="text/javascript">
<!--
h='&#116;&#104;&#x6f;&#x75;&#x67;&#104;&#116;&#98;&#x6f;&#116;&#46;&#x63;&#x6f;&#x6d;';a='&#64;';n='&#108;&#x65;&#x61;&#114;&#110;';e=n+a+h;
document.write('<a h'+'ref'+'="ma'+'ilto'+':'+e+'">'+e+'<\/'+'a'+'>');
// -->
</script><noscript>learn at thoughtbot dot com</noscript>.</p>
<p></p>
<p></p>
<p></p>
</section>
<section id="long-method" class="level1">
<h1><a href="#long-method">Long Method</a></h1>
<p>The most common smell in Rails applications is the Long Method.</p>
<p>Long methods are exactly what they sound like: methods that are too long. They're easy to spot.</p>
<section id="symptoms" class="level3">
<h3><a href="#symptoms">Symptoms</a></h3>
<ul>
<li>If you can't tell exactly what a method does at a glance, it's too long.</li>
<li>Methods with more than one level of nesting are usually too long.</li>
<li>Methods with more than one level of abstraction may be too long.</li>
<li>Methods with a flog score of 10 or higher may be too long.</li>
</ul>
<p>You can watch out for long methods as you write them, but finding existing methods is easiest with tools like flog:</p>
<pre><code>% flog app lib
    72.9: flog total
     5.6: flog/method average

    15.7: QuestionsController#create       app/controllers/questions_controller.rb:9
    11.7: QuestionsController#new          app/controllers/questions_controller.rb:2
    11.0: Question#none
     8.1: SurveysController#create         app/controllers/surveys_controller.rb:6</code></pre>
<p>Methods with higher scores are more complicated. Anything with a score higher than 10 is worth looking at, but flog only helps you find potential trouble spots; use your own judgment when refactoring.</p>
</section>
<section id="example" class="level3">
<h3><a href="#example">Example</a></h3>
<p>For an example of a long method, let's take a look at the highest scored method from flog, <code>QuestionsController#create</code>:</p>
<pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="kw">def</span> create
  <span class="ot">@survey</span> = <span class="dt">Survey</span>.find(params[<span class="st">:survey_id</span>])
  <span class="ot">@submittable_type</span> = params[<span class="st">:submittable_type_id</span>]
  question_params = params.
    require(<span class="st">:question</span>).
    permit(<span class="st">:submittable_type</span>, <span class="st">:title</span>, <span class="st">:options_attributes</span>, <span class="st">:minimum</span>, <span class="st">:maximum</span>)
  <span class="ot">@question</span> = <span class="ot">@survey</span>.questions.new(question_params)
  <span class="ot">@question</span>.submittable_type = <span class="ot">@submittable_type</span>

  <span class="kw">if</span> <span class="ot">@question</span>.save
    redirect_to <span class="ot">@survey</span>
  <span class="kw">else</span>
    render <span class="st">:new</span>
  <span class="kw">end</span>
<span class="kw">end</span></code></pre>
</section>
<section id="solutions" class="level3">
<h3><a href="#solutions">Solutions</a></h3>
<ul>
<li><a href="#extract-method">Extract method</a> is the most common way to break apart long methods.</li>
<li><a href="#replace-temp-with-query">Replace temp with query</a> if you have local variables in the method.</li>
</ul>
<p>After extracting methods, check for <a href="#feature-envy">feature envy</a> in the new methods to see if you should employ <a href="#move-method">move method</a> to provide the method with a better home.</p>
</section>
</section>
<section id="case-statement" class="level1">
<h1><a href="#case-statement">Case Statement</a></h1>
<p>Case Statements are a sign that a method contains too much knowledge.</p>
<section id="symptoms-1" class="level3">
<h3><a href="#symptoms-1">Symptoms</a></h3>
<ul>
<li>Case statements that check the class of an object.</li>
<li>Case statements that check a type code.</li>
<li><a href="#divergent-change">Divergent change</a> caused by changing or adding <code>when</code> clauses.</li>
<li><a href="#shotgun-surgery">Shotgun surgery</a> caused by duplicating the case statement.</li>
</ul>
<p>Actual <code>case</code> statements are extremely easy to find. Just grep your codebase for &quot;case.&quot; However, you should also be on the lookout for <code>case</code>'s sinister cousin, the repetitive <code>if-elsif</code>.</p>
</section>
<section id="type-codes" class="level2">
<h2><a href="#type-codes">Type Codes</a></h2>
<p>Some applications contain type codesâ€”fields that store type information about objects. These fields are easy to add and seem innocent, but result in code that's harder to maintain. A better solution is to take advantage of Ruby's ability to invoke different behavior based on an object's class, called &quot;dynamic dispatch.&quot; Using a case statement with a type code inelegantly reproduces dynamic dispatch.</p>
<p>The special <code>type</code> column that ActiveRecord uses is not necessarily a type code. The <code>type</code> column is used to serialize an object's class to the database so that the correct class can be instantiated later on. If you're just using the <code>type</code> column to let ActiveRecord decide which class to instantiate, this isn't a smell. However, make sure to avoid referencing the <code>type</code> column from <code>case</code> or <code>if</code> statements.</p>
<section id="example-1" class="level3">
<h3><a href="#example-1">Example</a></h3>
<p>This method summarizes the answers to a question. The summary varies based on the type of question.</p>
<pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="co"># app/models/question.rb</span>
<span class="kw">def</span> summary
  <span class="kw">case</span> question_type
  <span class="kw">when</span> <span class="st">'MultipleChoice'</span>
    summarize_multiple_choice_answers
  <span class="kw">when</span> <span class="st">'Open'</span>
    summarize_open_answers
  <span class="kw">when</span> <span class="st">'Scale'</span>
    summarize_scale_answers
  <span class="kw">end</span>
<span class="kw">end</span></code></pre>
<p></p>
<p>Note that many applications replicate the same <code>case</code> statement, which is a more serious offence. This view duplicates the <code>case</code> logic from <code>Question#summary</code>, this time in the form of multiple <code>if</code> statements:</p>
<pre class="sourceCode rhtml"><code class="sourceCode rhtml"># app/views/questions/_question.html.erb
<span class="kw">&lt;%</span> <span class="kw">if</span> question.question_type <span class="ch">==</span> <span class="st">'MultipleChoice'</span> <span class="kw">-%&gt;</span>
  <span class="kw">&lt;ol&gt;</span>
    <span class="kw">&lt;%</span> question.options.each <span class="kw">do</span> <span class="ch">|</span>option<span class="ch">|</span> <span class="kw">-%&gt;</span>
      <span class="kw">&lt;li&gt;</span>
        <span class="kw">&lt;%=</span> submission_fields.radio_button <span class="st">:text</span>, option.text, id: dom_id(option) <span class="kw">%&gt;</span>
        <span class="kw">&lt;%=</span> content_tag <span class="st">:label</span>, option.text, <span class="kw">for</span>: dom_id(option) <span class="kw">%&gt;</span>
      <span class="kw">&lt;/li&gt;</span>
    <span class="kw">&lt;%</span> <span class="kw">end</span> <span class="kw">-%&gt;</span>
  <span class="kw">&lt;/ol&gt;</span>
<span class="kw">&lt;%</span> <span class="kw">end</span> <span class="kw">-%&gt;</span>

<span class="kw">&lt;%</span> <span class="kw">if</span> question.question_type <span class="ch">==</span> <span class="st">'Scale'</span> <span class="kw">-%&gt;</span>
  <span class="kw">&lt;ol&gt;</span>
    <span class="kw">&lt;%</span> question.steps.each <span class="kw">do</span> <span class="ch">|</span>step<span class="ch">|</span> <span class="kw">-%&gt;</span>
      <span class="kw">&lt;li&gt;</span>
        <span class="kw">&lt;%=</span> submission_fields.radio_button <span class="st">:text</span>, step <span class="kw">%&gt;</span>
        <span class="kw">&lt;%=</span> submission_fields.label <span class="st">&quot;text_</span><span class="ot">#{</span>step<span class="ot">}</span><span class="st">&quot;</span>, label: step <span class="kw">%&gt;</span>
      <span class="kw">&lt;/li&gt;</span>
    <span class="kw">&lt;%</span> <span class="kw">end</span> <span class="kw">-%&gt;</span>
  <span class="kw">&lt;/ol&gt;</span>
<span class="kw">&lt;%</span> <span class="kw">end</span> <span class="kw">-%&gt;</span></code></pre>
</section>
<section id="solutions-1" class="level3">
<h3><a href="#solutions-1">Solutions</a></h3>
<ul>
<li><a href="#replace-type-code-with-subclasses">Replace type code with subclasses</a> if the <code>case</code> statement is checking a type code, such as <code>question_type</code>.</li>
<li><a href="#replace-conditional-with-polymorphism">Replace conditional with polymorphism</a> when the <code>case</code> statement is checking the class of an object.</li>
<li><a href="#use-convention-over-configuration">Use convention over configuration</a> when selecting a strategy based on a string name.</li>
</ul>
</section>
</section>
</section>
<section id="shotgun-surgery" class="level1">
<h1><a href="#shotgun-surgery">Shotgun Surgery</a></h1>
<p>Shotgun Surgery is usually a more obvious symptom that reveals another smell.</p>
<section id="symptoms-2" class="level3">
<h3><a href="#symptoms-2">Symptoms</a></h3>
<ul>
<li>You have to make the same small change across several different files.</li>
<li>Changes become difficult to manage because they are hard to keep track of.</li>
</ul>
<p>Make sure you look for related smells in the affected code:</p>
<ul>
<li><a href="#duplicated-code">Duplicated code</a></li>
<li><a href="#case-statement">Case statement</a></li>
<li><a href="#feature-envy">Feature envy</a></li>
<li><a href="#long-parameter-list">Long parameter list</a></li>
</ul>
</section>
<section id="example-2" class="level3">
<h3><a href="#example-2">Example</a></h3>
<p>Users' names are formatted and displayed as &quot;First Last&quot; throughout the application. If you want to change the formatting to include a middle initial (example: &quot;First M. Last&quot;) you'll need to make the same small change in several places.</p>
<pre class="sourceCode rhtml"><code class="sourceCode rhtml"># app/views/users/show.html.erb
<span class="kw">&lt;%=</span> current_user.first_name <span class="kw">%&gt;</span> <span class="kw">&lt;%=</span> current_user.last_name <span class="kw">%&gt;</span>

# app/views/users/index.html.erb
<span class="kw">&lt;%=</span> current_user.first_name <span class="kw">%&gt;</span> <span class="kw">&lt;%=</span> current_user.last_name <span class="kw">%&gt;</span>

# app/views/layouts/application.html.erb
<span class="kw">&lt;%=</span> current_user.first_name <span class="kw">%&gt;</span> <span class="kw">&lt;%=</span> current_user.last_name <span class="kw">%&gt;</span>

# app/views/mailers/completion_notification.html.erb
<span class="kw">&lt;%=</span> current_user.first_name <span class="kw">%&gt;</span> <span class="kw">&lt;%=</span> current_user.last_name <span class="kw">%&gt;</span></code></pre>
</section>
<section id="solutions-2" class="level3">
<h3><a href="#solutions-2">Solutions</a></h3>
<ul>
<li><a href="#replace-conditional-with-polymorphism">Replace conditional with polymorphism</a> to replace duplicated <code>case</code> statements and <code>if-elsif</code> blocks.</li>
<li><a href="#replace-conditional-with-null-object">Replace conditional with null object</a> if changing a method to return <code>nil</code> would require checks for <code>nil</code> in several places.</li>
<li><a href="#extract-decorator">Extract decorator</a> to replace duplicated display code in views/templates.</li>
<li><a href="#introduce-parameter-object">Introduce parameter object</a> to hang useful formatting methods alongside a data clump of related attributes.</li>
<li><a href="#use-convention-over-configuration">Use convention over configuration</a> to eliminate small steps that can be inferred based on a convention, such as a name.</li>
<li><a href="#inline-class">Inline class</a> if the class only serves to add extra steps when performing changes.</li>
</ul>
</section>
<section id="prevention" class="level3">
<h3><a href="#prevention">Prevention</a></h3>
<p>If your changes become spread out because you need to pass information between boundaries for dependencies, try <a href="#dependency-inversion-principle">inverting control</a>.</p>
<p>If you find yourself repeating the exact same change in several places, make sure that you <a href="#dry">Don't Repeat Yourself</a>.</p>
<p>If you need to change several places because of a modification in your dependency chain, such as changing <code>user.plan.price</code> to <code>user.account.plan.price</code>, make sure that you're following the <a href="#law-of-demeter">law of Demeter</a>.</p>
<p>If conditional logic is affected in several places by a single, cohesive change, make sure that you're following <a href="#tell-dont-ask">tell, don't ask</a>.</p>
<p></p>
</section>
</section>
<section id="replace-conditional-with-null-object" class="level1">
<h1><a href="#replace-conditional-with-null-object">Replace Conditional with Null Object</a></h1>
<p>Every Ruby developer is familiar with <code>nil</code>, and Ruby on Rails comes with a full complement of tools to handle it: <code>nil?</code>, <code>present?</code>, <code>try</code> and more. However, it's easy to let these tools hide duplication and leak concerns. If you find yourself checking for <code>nil</code> all over your codebase, try replacing some of the <code>nil</code> values with Null Objects.</p>
<section id="uses" class="level3">
<h3><a href="#uses">Uses</a></h3>
<ul>
<li>Removes <a href="#shotgun-surgery">shotgun surgery</a> when an existing method begins returning <code>nil</code>.</li>
<li>Removes <a href="#duplicated-code">duplicated code</a> related to checking for <code>nil</code>.</li>
<li>Removes clutter, improving readability of code that consumes <code>nil</code>.</li>
<li>Makes logic related to presence and absence easier to reuse, making it easier to <a href="#dry">avoid duplication</a>.</li>
<li>Replaces conditional logic with simple commands, following <a href="#tell-dont-ask">tell, don't ask</a>.</li>
</ul>
</section>
<section id="example-3" class="level3">
<h3><a href="#example-3">Example</a></h3>
<pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="co"># app/models/question.rb</span>
<span class="kw">def</span> most_recent_answer_text
  answers.most_recent.try(<span class="st">:text</span>) || <span class="dt">Answer</span>::<span class="dt">MISSING_TEXT</span>
<span class="kw">end</span></code></pre>
<p>The <code>most_recent_answer_text</code> method asks its <code>answers</code> association for <code>most_recent</code> answer. It only wants the <code>text</code> from that answer, but it must first check to make sure that an answer actually exists to get <code>text</code> from. It needs to perform this check because <code>most_recent</code> might return <code>nil</code>:</p>
<pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="co"># app/models/answer.rb</span>
<span class="kw">def</span> <span class="dv">self</span>.most_recent
  order(<span class="st">:created_at</span>).last
<span class="kw">end</span></code></pre>
<p>This call clutters up the method, and returning <code>nil</code> is contagious: Any method that calls <code>most_recent</code> must also check for <code>nil</code>. The concept of a missing answer is likely to come up more than once, as in this example:</p>
<pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="co"># app/models/user.rb</span>
<span class="kw">def</span> answer_text_for(question)
  question.answers.for_user(<span class="dv">self</span>).try(<span class="st">:text</span>) || <span class="dt">Answer</span>::<span class="dt">MISSING_TEXT</span>
<span class="kw">end</span></code></pre>
<p>Again, <code>for_user</code> might return <code>nil</code>:</p>
<pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="co"># app/models/answer.rb</span>
<span class="kw">def</span> <span class="dv">self</span>.for_user(user)
  joins(<span class="st">:completion</span>).where(completions: { user_id: user.id }).last
<span class="kw">end</span></code></pre>
<p>The <code>User#answer_text_for</code> method duplicates the check for a missing answerâ€”and worse, it's repeating the logic of what happens when you need text without an answer.</p>
<p>We can remove these checks entirely from <code>Question</code> and <code>User</code> by introducing a null object:</p>
<pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="co"># app/models/question.rb</span>
<span class="kw">def</span> most_recent_answer_text
  answers.most_recent.text
<span class="kw">end</span></code></pre>
<pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="co"># app/models/user.rb</span>
<span class="kw">def</span> answer_text_for(question)
  question.answers.for_user(<span class="dv">self</span>).text
<span class="kw">end</span></code></pre>
<p>We're now just assuming that <code>Answer</code> class methods will return something answer-like; specifically, we expect an object that returns useful <code>text</code>. We can refactor <code>Answer</code> to handle the <code>nil</code> check:</p>
<pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="co"># app/models/answer.rb</span>
<span class="kw">class</span> <span class="dt">Answer</span> &lt; <span class="dt">ActiveRecord</span>::<span class="dt">Base</span>
  <span class="kw">include</span> <span class="dt">ActiveModel</span>::<span class="dt">ForbiddenAttributesProtection</span>

  belongs_to <span class="st">:completion</span>
  belongs_to <span class="st">:question</span>

  validates <span class="st">:text</span>, presence: <span class="dv">true</span>

  <span class="kw">def</span> <span class="dv">self</span>.for_user(user)
    joins(<span class="st">:completion</span>).where(completions: { user_id: user.id }).last ||
      <span class="dt">NullAnswer</span>.new
  <span class="kw">end</span>

  <span class="kw">def</span> <span class="dv">self</span>.most_recent
    order(<span class="st">:created_at</span>).last || <span class="dt">NullAnswer</span>.new
  <span class="kw">end</span>
<span class="kw">end</span></code></pre>
<p>Note that <code>for_user</code> and <code>most_recent</code> return a <code>NullAnswer</code> if no answer can be found, so these methods will never return <code>nil</code>. The implementation for <code>NullAnswer</code> is simple:</p>
<pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="co"># app/models/null_answer.rb</span>
<span class="kw">class</span> <span class="dt">NullAnswer</span>
  <span class="kw">def</span> text
    <span class="st">'No response'</span>
  <span class="kw">end</span>
<span class="kw">end</span></code></pre>
<p>We can take things just a little further and remove a bit of duplication with a quick <a href="#extract-method">extract method</a>:</p>
<pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="co"># app/models/answer.rb</span>
<span class="kw">class</span> <span class="dt">Answer</span> &lt; <span class="dt">ActiveRecord</span>::<span class="dt">Base</span>
  <span class="kw">include</span> <span class="dt">ActiveModel</span>::<span class="dt">ForbiddenAttributesProtection</span>

  belongs_to <span class="st">:completion</span>
  belongs_to <span class="st">:question</span>

  validates <span class="st">:text</span>, presence: <span class="dv">true</span>

  <span class="kw">def</span> <span class="dv">self</span>.for_user(user)
    joins(<span class="st">:completion</span>).where(completions: { user_id: user.id }).last_or_null
  <span class="kw">end</span>

  <span class="kw">def</span> <span class="dv">self</span>.most_recent
    order(<span class="st">:created_at</span>).last_or_null
  <span class="kw">end</span>

  <span class="kw">private</span>

  <span class="kw">def</span> <span class="dv">self</span>.last_or_null
    last || <span class="dt">NullAnswer</span>.new
  <span class="kw">end</span>
<span class="kw">end</span></code></pre>
<p>Now we can easily create <code>Answer</code> class methods that return a usable answer, no matter what.</p>
</section>
<section id="drawbacks" class="level3">
<h3><a href="#drawbacks">Drawbacks</a></h3>
<p>Introducing a null object can remove duplication and clutter. But it can also cause pain and confusion:</p>
<ul>
<li>As a developer reading a method like <code>Question#most_recent_answer_text</code>, you may be confused to find that <code>most_recent_answer</code> returned an instance of <code>NullAnswer</code> and not <code>Answer</code>.</li>
<li>It's possible some methods will need to distinguish between <code>NullAnswer</code>s and real <code>Answer</code>s. This is common in views, when special markup is required to denote missing values. In this case, you'll need to add explicit <code>present?</code> checks and define <code>present?</code> to return <code>false</code> on your null object.</li>
<li><code>NullAnswer</code> may eventually need to reimplement large part of the <code>Answer</code> API, leading to potential <a href="#duplicated-code">duplicated code</a> and <a href="#shotgun-surgery">shotgun surgery</a>, which is largely what we hoped to solve in the first place.</li>
</ul>
<p>Don't introduce a null object until you find yourself swatting enough <code>nil</code> values to grow annoyed. And make sure the removal of the <code>nil</code>-handling logic outweighs the drawbacks above.</p>
</section>
<section id="next-steps" class="level3">
<h3><a href="#next-steps">Next Steps</a></h3>
<ul>
<li>Look for other <code>nil</code> checks of the return values of refactored methods.</li>
<li>Make sure your null object class implements the required methods from the original class.</li>
<li>Make sure no <a href="#duplicated-code">duplicated code</a> exists between the null object class and the original.</li>
</ul>
<p></p>
</section>
<section id="truthiness-try-and-other-tricks" class="level2">
<h2><a href="#truthiness-try-and-other-tricks">Truthiness, <code>try</code> and Other Tricks</a></h2>
<p>All checks for <code>nil</code> are a condition, but Ruby provides many ways to check for <code>nil</code> without using an explicit <code>if</code>. Watch out for <code>nil</code> conditional checks disguised behind other syntax. The following are all roughly equivalent:</p>
<pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="co"># Explicit if with nil?</span>
<span class="kw">if</span> user.nil?
  <span class="dv">nil</span>
<span class="kw">else</span>
  user.name
<span class="kw">end</span>

<span class="co"># Implicit nil check through truthy conditional</span>
<span class="kw">if</span> user
  user.name
<span class="kw">end</span>

<span class="co"># Relies on nil being falsey</span>
user &amp;&amp; user.name

<span class="co"># Call to try</span>
user.try(<span class="st">:name</span>)</code></pre>
</section>
</section>
<section id="extract-method" class="level1">
<h1><a href="#extract-method">Extract Method</a></h1>
<p>The simplest refactoring to perform is extract method. To extract a method:</p>
<ul>
<li>Pick a name for the new method.</li>
<li>Move extracted code into the new method.</li>
<li>Call the new method from the point of extraction.</li>
</ul>
<section id="uses-1" class="level3">
<h3><a href="#uses-1">Uses</a></h3>
<ul>
<li>Removes <a href="#long-method">long methods</a>.</li>
<li>Sets the stage for moving behavior via <a href="#move-method">move method</a>.</li>
<li>Resolves obscurity by introducing intention-revealing names.</li>
<li>Allows removal of <a href="#duplicated-code">duplicated code</a> by moving the common code into the extracted method.</li>
<li>Reveals complexity, making it easier to follow the <a href="#single-responsibility-principle">single responsibility principle</a>.</li>
<li>Makes behavior easier to reuse, which makes it easier to <a href="#dry">avoid duplication</a>.</li>
</ul>
<p></p>
</section>
<section id="example-4" class="level3">
<h3><a href="#example-4">Example</a></h3>
<p>Let's take a look at an example of <a href="#long-method">long method</a> and improve it by extracting smaller methods:</p>
<pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="kw">def</span> create
  <span class="ot">@survey</span> = <span class="dt">Survey</span>.find(params[<span class="st">:survey_id</span>])
  <span class="ot">@submittable_type</span> = params[<span class="st">:submittable_type_id</span>]
  question_params = params.
    require(<span class="st">:question</span>).
    permit(<span class="st">:submittable_type</span>, <span class="st">:title</span>, <span class="st">:options_attributes</span>, <span class="st">:minimum</span>, <span class="st">:maximum</span>)
  <span class="ot">@question</span> = <span class="ot">@survey</span>.questions.new(question_params)
  <span class="ot">@question</span>.submittable_type = <span class="ot">@submittable_type</span>

  <span class="kw">if</span> <span class="ot">@question</span>.save
    redirect_to <span class="ot">@survey</span>
  <span class="kw">else</span>
    render <span class="st">:new</span>
  <span class="kw">end</span>
<span class="kw">end</span></code></pre>
<p>This method performs a number of tasks:</p>
<ul>
<li>It finds the survey that the question should belong to.</li>
<li>It figures out what type of question we're creating (the <code>submittable_type</code>).</li>
<li>It builds parameters for the new question by applying a white list to the HTTP parameters.</li>
<li>It builds a question from the given survey, parameters and submittable type.</li>
<li>It attempts to save the question.</li>
<li>It redirects back to the survey for a valid question.</li>
<li>It re-renders the form for an invalid question.</li>
</ul>
<p>Any of these tasks can be extracted to a method. Let's start by extracting the task of building the question.</p>
<pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="kw">def</span> create
  <span class="ot">@survey</span> = <span class="dt">Survey</span>.find(params[<span class="st">:survey_id</span>])
  <span class="ot">@submittable_type</span> = params[<span class="st">:submittable_type_id</span>]
  build_question

  <span class="kw">if</span> <span class="ot">@question</span>.save
    redirect_to <span class="ot">@survey</span>
  <span class="kw">else</span>
    render <span class="st">:new</span>
  <span class="kw">end</span>
<span class="kw">end</span>

<span class="kw">private</span>

<span class="kw">def</span> build_question
  question_params = params.
    require(<span class="st">:question</span>).
    permit(<span class="st">:submittable_type</span>, <span class="st">:title</span>, <span class="st">:options_attributes</span>, <span class="st">:minimum</span>, <span class="st">:maximum</span>)
  <span class="ot">@question</span> = <span class="ot">@survey</span>.questions.new(question_params)
  <span class="ot">@question</span>.submittable_type = <span class="ot">@submittable_type</span>
<span class="kw">end</span></code></pre>
<p>The <code>create</code> method is already much more readable. The new <code>build_question</code> method is noisy, though, with the wrong details at the beginning. The task of pulling out question parameters is clouding up the task of building the question. Let's extract another method.</p>
<p></p>
</section>
<section id="replace-temp-with-query" class="level2">
<h2><a href="#replace-temp-with-query">Replace Temp with Query</a></h2>
<p>One simple way to extract methods is by replacing local variables. Let's pull <code>question_params</code> into its own method:</p>
<pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="kw">def</span> build_question
  <span class="ot">@question</span> = <span class="ot">@survey</span>.questions.new(question_params)
  <span class="ot">@question</span>.submittable_type = <span class="ot">@submittable_type</span>
<span class="kw">end</span>

<span class="kw">def</span> question_params
  params.
    require(<span class="st">:question</span>).
    permit(<span class="st">:submittable_type</span>, <span class="st">:title</span>, <span class="st">:options_attributes</span>, <span class="st">:minimum</span>, <span class="st">:maximum</span>)
<span class="kw">end</span></code></pre>
<section id="other-examples" class="level3">
<h3><a href="#other-examples">Other Examples</a></h3>
<p>For more examples of <a href="#extract-method">extract method</a>, take a look at these chapters:</p>
<ul>
<li><a href="#extract-class">Extract class</a>: <a href="https://github.com/thoughtbot/ruby-science/commit/b434954d">b434954d</a>, <a href="https://github.com/thoughtbot/ruby-science/commit/000babe1">000babe1</a></li>
<li><a href="#extract-decorator">Extract decorator</a>: <a href="https://github.com/thoughtbot/ruby-science/commit/15f5b96e">15f5b96e</a></li>
<li><a href="#introduce-explaining-variable">Introduce explaining variable</a> (inline)</li>
<li><a href="#move-method">Move method</a>: <a href="https://github.com/thoughtbot/ruby-science/commit/d5b4871">d5b4871</a></li>
<li><a href="#replace-conditional-with-null-object">Replace conditional with null object</a>: <a href="https://github.com/thoughtbot/ruby-science/commit/1e35c68">1e35c68</a></li>
</ul>
</section>
<section id="next-steps-1" class="level3">
<h3><a href="#next-steps-1">Next Steps</a></h3>
<ul>
<li>Check the original method and the extracted method to make sure neither is a <a href="#long-method">long method</a>.</li>
<li>Check the original method and the extracted method to make sure that they both relate to the same core concern. If the methods aren't highly related, the class will suffer from <a href="#divergent-change">divergent change</a>.</li>
<li>Check newly extracted methods for <a href="#feature-envy">feature envy</a>. If you find some, you may wish to employ <a href="#move-method">move method</a> to provide the new method with a better home.</li>
<li>Check the affected class to make sure it's not a <a href="#large-class">large class</a>. Extracting methods reveals complexity, making it clearer when a class is doing too much.</li>
</ul>
</section>
</section>
</section>
<section id="extract-partial" class="level1">
<h1><a href="#extract-partial">Extract Partial</a></h1>
<p>Extracting a partial is a technique used for removing complex or duplicated view code from your application. This is the equivalent of using <a href="#long-method">long method</a> and <a href="#extract-method">extract method</a> in your views and templates.</p>
<section id="uses-2" class="level3">
<h3><a href="#uses-2">Uses</a></h3>
<ul>
<li>Removes <a href="#duplicated-code">duplicated code</a> from views.</li>
<li>Avoids <a href="#shotgun-surgery">shotgun surgery</a> by forcing changes to happen in one place.</li>
<li>Removes <a href="#divergent-change">divergent change</a> by removing a reason for the view to change.</li>
<li>Groups common code.</li>
<li>Reduces view size and complexity.</li>
<li>Makes view logic easier to reuse, which makes it easier to <a href="#dry">avoid duplication</a>.</li>
</ul>
</section>
<section id="steps" class="level3">
<h3><a href="#steps">Steps</a></h3>
<ul>
<li>Create a new file for partial prefixed with an underscore (_filename.html.erb).</li>
<li>Move common code into newly created file.</li>
<li>Render the partial from the source file.</li>
</ul>
</section>
<section id="example-5" class="level3">
<h3><a href="#example-5">Example</a></h3>
<p>Let's revisit the view code for <em>adding</em> and <em>editing</em> questions.</p>
<p>Note: There are a few small differences in the files (the URL endpoint and the label on the submit button).</p>
<pre class="sourceCode rhtml"><code class="sourceCode rhtml"># app/views/questions/new.html.erb
<span class="kw">&lt;h1&gt;</span>Add Question<span class="kw">&lt;/h1&gt;</span>

<span class="kw">&lt;%=</span> simple_form_for <span class="ot">@question</span>, as: <span class="st">:question</span>, url: survey_questions_path(<span class="ot">@survey</span>) <span class="kw">do</span> <span class="ch">|</span>form<span class="ch">|</span> <span class="kw">-%&gt;</span>
  <span class="kw">&lt;%=</span> form.hidden_field <span class="st">:type</span> <span class="kw">%&gt;</span>
  <span class="kw">&lt;%=</span> form.input <span class="st">:title</span> <span class="kw">%&gt;</span>
  <span class="kw">&lt;%=</span> render <span class="st">&quot;</span><span class="ot">#{@question</span>.to_partial_path<span class="ot">}</span><span class="st">_form&quot;</span>, question: <span class="ot">@question</span>, form: form <span class="kw">%&gt;</span>
  <span class="kw">&lt;%=</span> form.submit <span class="st">'Create Question'</span> <span class="kw">%&gt;</span>
<span class="kw">&lt;%</span> <span class="kw">end</span> <span class="kw">-%&gt;</span></code></pre>
<pre class="sourceCode rhtml"><code class="sourceCode rhtml"># app/views/questions/edit.html.erb
<span class="kw">&lt;h1&gt;</span>Edit Question<span class="kw">&lt;/h1&gt;</span>

<span class="kw">&lt;%=</span> simple_form_for <span class="ot">@question</span>, as: <span class="st">:question</span>, url: question_path <span class="kw">do</span> <span class="ch">|</span>form<span class="ch">|</span> <span class="kw">-%&gt;</span>
  <span class="kw">&lt;%=</span> form.hidden_field <span class="st">:type</span> <span class="kw">%&gt;</span>
  <span class="kw">&lt;%=</span> form.input <span class="st">:title</span> <span class="kw">%&gt;</span>
  <span class="kw">&lt;%=</span> render <span class="st">&quot;</span><span class="ot">#{@question</span>.to_partial_path<span class="ot">}</span><span class="st">_form&quot;</span>, question: <span class="ot">@question</span>, form: form <span class="kw">%&gt;</span>
  <span class="kw">&lt;%=</span> form.submit <span class="st">'Update Question'</span> <span class="kw">%&gt;</span>
<span class="kw">&lt;%</span> <span class="kw">end</span> <span class="kw">-%&gt;</span></code></pre>
<p>First, extract the common code into a partial, remove any instance variables and use <code>question</code> and <code>url</code> as local variables:</p>
<pre class="sourceCode rhtml"><code class="sourceCode rhtml"># app/views/questions/_form.html.erb
<span class="kw">&lt;%=</span> simple_form_for question, as: <span class="st">:question</span>, url: url <span class="kw">do</span> <span class="ch">|</span>form<span class="ch">|</span> <span class="kw">-%&gt;</span>
  <span class="kw">&lt;%=</span> form.hidden_field <span class="st">:type</span> <span class="kw">%&gt;</span>
  <span class="kw">&lt;%=</span> form.input <span class="st">:title</span> <span class="kw">%&gt;</span>
  <span class="kw">&lt;%=</span> render <span class="st">&quot;</span><span class="ot">#{</span>question.to_partial_path<span class="ot">}</span><span class="st">_form&quot;</span>, question: question, form: form <span class="kw">%&gt;</span>
  <span class="kw">&lt;%=</span> form.submit <span class="kw">%&gt;</span>
<span class="kw">&lt;%</span> <span class="kw">end</span> <span class="kw">-%&gt;</span></code></pre>
<p>Move the submit button text into the locales file:</p>
<pre><code># config/locales/en.yml
en:
  helpers:
    submit:
      question:
        create: 'Create Question'
        update: 'Update Question'</code></pre>
<p>Then render the partial from each of the views, passing in the values for <code>question</code> and <code>url</code>:</p>
<pre class="sourceCode rhtml"><code class="sourceCode rhtml"># app/views/questions/new.html.erb
<span class="kw">&lt;h1&gt;</span>Add Question<span class="kw">&lt;/h1&gt;</span>

<span class="kw">&lt;%=</span> render <span class="st">'form'</span>, question: <span class="ot">@question</span>, url: survey_questions_path(<span class="ot">@survey</span>) <span class="kw">%&gt;</span></code></pre>
<pre class="sourceCode rhtml"><code class="sourceCode rhtml"># app/views/questions/edit.html.erb
<span class="kw">&lt;h1&gt;</span>Edit Question<span class="kw">&lt;/h1&gt;</span>

<span class="kw">&lt;%=</span> render <span class="st">'form'</span>, question: <span class="ot">@question</span>, url: question_path <span class="kw">%&gt;</span></code></pre>
</section>
<section id="next-steps-2" class="level3">
<h3><a href="#next-steps-2">Next Steps</a></h3>
<ul>
<li>Check for other occurrences of the duplicated view code in your application and replace them with the newly extracted partial.</li>
</ul>
<p></p>
</section>
</section>
<section id="closing" class="level1">
<h1><a href="#closing">Closing</a></h1>
<p>Thanks for checking out this sample of <em>Ruby Science</em>. If you'd like to get access to the full content, the example application, ongoing updates and the opportunity to have your questions about Ruby on Rails answered by us, you can get it all on our website:</p>
<p><a href="http://www.rubyscience.com">http://www.rubyscience.com</a></p>
</section>
</body>
</html>
